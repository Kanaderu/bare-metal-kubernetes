---

- name: configure master node
  hosts: k8smasters
  tags:
    - config_k8s
    - config_k8s_master
  tasks:
    - name: include docker role
      include_role:
        name: docker
    - name: include kubernetes
      include_role:
        name: kubernetes
    - name: include calico role
      include_role:
        name: calico
    # - name: include purelb load balancer
    #   include_role:
    #     name: purelb
    - name: include metallb load balancer
      include_role:
        name: metallb

- name: k8s config worker nodes
  hosts: k8sworkers
  tags:
    - config_k8s
    - config_k8s_nodes
  tasks:
    - name: upload join script
      copy:
        src: /tmp/join_node.sh
        dest: /root/join_node.sh
        owner: root
        group: root
        mode: '0755'
    - name: join cluster
      command: /root/join_node.sh
    - name: enable start kubelet
      service:
        name: kubelet
        state: started
        enabled: yes

- name: test nodes joined
  hosts: k8smasters
  tags:
    - config_k8s
    - check_nodes
  tasks:
    - name: check for nodes
      become: no
      command: kubectl get nodes
      register: nodelist
    - name: show nodes
      debug:
        var: nodelist.stdout_lines
